name: Build macOS DMG

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Import signing certificate
      if: github.event_name != 'pull_request'
      env:
        CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
        CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create variables
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # Decode certificate from base64
        echo "$CERTIFICATE_BASE64" | tr -d '\n' | base64 -d > $CERTIFICATE_PATH

        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Import certificate to keychain
        security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH >/dev/null 2>&1
        security list-keychain -d user -s $KEYCHAIN_PATH

        # Set partition list to allow codesign to access the keychain
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH >/dev/null 2>&1

    - name: Build app (with code signing)
      if: github.event_name != 'pull_request'
      env:
        DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        xcodebuild -project Toolbox.xcodeproj \
          -scheme Toolbox \
          -configuration Release \
          -derivedDataPath ./build \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
          CODE_SIGN_IDENTITY="Developer ID Application"

    - name: Build app (without code signing for PRs)
      if: github.event_name == 'pull_request'
      run: |
        xcodebuild -project Toolbox.xcodeproj \
          -scheme Toolbox \
          -configuration Release \
          -derivedDataPath ./build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM=""

    - name: Create DMG
      run: |
        # Create a directory for DMG contents
        mkdir -p dmg_contents

        # Copy the app to DMG contents
        cp -r ./build/Build/Products/Release/Toolbox.app dmg_contents/

        # Create the DMG
        hdiutil create -volname "Toolbox" \
          -srcfolder dmg_contents \
          -ov -format UDZO \
          Toolbox.dmg

    - name: Sign and notarize DMG
      if: github.event_name != 'pull_request'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        # Sign the DMG
        codesign --sign "Developer ID Application" --deep --force --options runtime Toolbox.dmg

        # Submit DMG for notarization
        xcrun notarytool submit Toolbox.dmg \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_APP_SPECIFIC_PASSWORD" \
          --team-id "$APPLE_TEAM_ID" \
          --wait

        # Wait a bit for the ticket to propagate
        sleep 10

        # Staple the notarization ticket to DMG
        xcrun stapler staple Toolbox.dmg

    - name: Upload DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: Toolbox-dmg
        path: Toolbox.dmg
        retention-days: 90

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: Toolbox.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
