name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode 26.1
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.1.1'

    - name: Prepare signing certificates and provisioning profiles
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
        BUILD_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        PP_PATH=$RUNNER_TEMP/build_pp.provisionprofile
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        echo -n "$BUILD_CERTIFICATE_BASE64" | tr -d '\n' | base64 -d > $CERTIFICATE_PATH

        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        security import $CERTIFICATE_PATH -P "$BUILD_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH >/dev/null 2>&1
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH >/dev/null 2>&1
        security list-keychain -d user -s $KEYCHAIN_PATH

    - name: Build App
      env:
        DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        xcodebuild clean archive \
          -project Toolbox.xcodeproj \
          -scheme Toolbox \
          -archivePath Toolbox \
          DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
          CODE_SIGN_IDENTITY="Developer ID Application" \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_INJECT_BASE_ENTITLEMENTS=NO

        xcodebuild -exportArchive \
          -archivePath Toolbox.xcarchive \
          -exportPath Release \
          -exportOptionsPlist Toolbox/export.plist

    - name: Create DMG
      run: |
        mkdir -p dmg_contents

        mv ./Release/Toolbox.app dmg_contents/

        hdiutil create -volname "Toolbox" \
          -srcfolder dmg_contents \
          -ov -format UDZO \
          Toolbox.dmg

    - name: Sign and notarize DMG
      if: github.event_name != 'pull_request'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        codesign --sign "Developer ID Application" --force --options runtime --timestamp Toolbox.dmg

        xcrun notarytool submit Toolbox.dmg \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_APP_SPECIFIC_PASSWORD" \
          --team-id "$APPLE_TEAM_ID" \
          --verbose \
          --output-format json \
          --wait > notarization.json

        SUBMISSION_ID=$(jq -r '.id' notarization.json)

        xcrun notarytool log "$SUBMISSION_ID" \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_APP_SPECIFIC_PASSWORD" \
          --team-id "$APPLE_TEAM_ID"

        sleep 10

        xcrun stapler staple Toolbox.dmg

    - name: Read version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Install Sparkle tools
      run: |
        curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz -o sparkle.tar.xz
        tar -xf sparkle.tar.xz
        chmod +x bin/generate_appcast bin/sign_update

    - name: Retrieve Sparkle private key
      env:
        SPARKLE_EDDSA_KEY: ${{ secrets.SPARKLE_EDDSA_KEY }}
      run: |
        echo "$SPARKLE_EDDSA_KEY" > sparkle_key

    - name: Read DMG size
      id: dmg_info
      run: |
        DMG_SIZE=$(stat -f%z Toolbox.dmg)
        echo "DMG_SIZE=$DMG_SIZE" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: Toolbox.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Sign DMG for Sparkle
      run: |
        SIGNATURE=$(./bin/sign_update Toolbox.dmg -f sparkle_key)
        echo "SPARKLE_SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
        echo "Sparkle signature: $SIGNATURE"

    - name: Update Sparkle appcast
      run: |
        export DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/Toolbox.dmg"

        python3 << 'EOF'
        import xml.etree.ElementTree as ET
        from datetime import datetime
        import os

        tree = ET.parse('docs/appcast.xml')
        root = tree.getroot()
        channel = root.find('channel')

        item = ET.SubElement(channel, 'item')
        ET.SubElement(item, 'title').text = f"Version ${{ steps.version.outputs.VERSION }}"
        ET.SubElement(item, 'pubDate').text = datetime.utcnow().strftime('%a, %d %b %Y %H:%M:%S +0000')

        enclosure = ET.SubElement(item, 'enclosure')
        enclosure.set('url', os.environ['DOWNLOAD_URL'])
        enclosure.set('length', '${{ steps.dmg_info.outputs.DMG_SIZE }}')
        enclosure.set('type', 'application/octet-stream')
        enclosure.set('sparkle:version', '${{ steps.version.outputs.VERSION }}')
        enclosure.set('sparkle:shortVersionString', '${{ steps.version.outputs.VERSION }}')
        enclosure.set('sparkle:edSignature', os.environ['SPARKLE_SIGNATURE'])

        tree.write('docs/appcast.xml', encoding='utf-8', xml_declaration=True)
        EOF

        cat docs/appcast.xml

    - name: Deploy Sparkle appcast to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages
